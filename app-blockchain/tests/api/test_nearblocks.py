import datetime
from decimal import Decimal
from unittest import TestCase
from unittest.mock import Mock

from exchange.base.models import Currencies
from exchange.blockchain.api.near.near_nearblocks import NearBlocksAPI


class TestNearblocksAPI(TestCase):
    nearblocks = NearBlocksAPI()
    nearblocks.request = Mock()

    def test_get_balance(self):
        address = '1f921e546971e2eed170f438506069ccbc96c9a98ddf622a3ba42582f9d2464c'
        mocked_response = {'balance': '0.01821'}
        self.nearblocks.request.return_value = mocked_response
        balance = self.nearblocks.get_balance(address)
        assert len(list(balance)) == 1
        assert list(balance) == [Currencies.near]
        assert balance.get(Currencies.near).get('symbol') == NearBlocksAPI.symbol
        assert balance.get(Currencies.near).get('amount') == Decimal('0.01821')

        address = 'sweat_welcome.near'
        mocked_response = {'balance': '6,639.78777'}
        self.nearblocks.request.return_value = mocked_response
        balance = self.nearblocks.get_balance(address)
        assert len(list(balance)) == 1
        assert list(balance) == [Currencies.near]
        assert balance.get(Currencies.near).get('symbol') == NearBlocksAPI.symbol
        assert balance.get(Currencies.near).get('amount') == Decimal('6639.78777')

    def test_get_block_head(self):
        mocked_response = {'blocks': [{'block_height': 69443138, 'block_hash': '88iKZbLGJ9R5p1suUstGMSNeZAp7Boj6wTZFSwX6R4Uy', 'block_timestamp': 1657351483594345200, 'txn': 4, 'receipt': 16, 'author': 'stake1.poolv1.near', 'gas_used': 16411868843028, 'gas_limit': 4000000000000000, 'gas_fee': '1.6411868843028e+21'}]}
        self.nearblocks.request.return_value = mocked_response
        block_height = self.nearblocks.get_block_head()
        assert block_height == 69443138

    def test_get_txs(self):
        address = 'scarefacepmpdn.near'
        mocked_response = [
            {'blocks': [{'block_height': 69571630, 'block_hash': '2ZVcUiyGzfwHu78wcjDUxSEQL7MGRVBZMnCGgvmuxj86', 'block_timestamp': 1657503916896402000, 'txn': 5, 'receipt': 12, 'author': 'electric.poolv1.near', 'gas_used': 98909225570203, 'gas_limit': 4000000000000000, 'gas_fee': '9.8909225570203e+21'}]},
            {'txns': [{'transaction_hash': 'HUpFB35TnxWaQwAnkW2x8kBowcSSZqZQ1iVg7ryPuCJC', 'type': 'Starfish Reward 4', 'height': 69560500, 'included_in_block_hash': '4wvWMEWQLbMDnQ8yQeCVEMGDCrJKw2PdiE83w8S5kKAU', 'block_timestamp': 1657490831105404200, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '652218013242100000000'}, {'transaction_hash': '64aAuBxBsQkdCWK9NLpg4pbzVRraqwwo17xZ1w9jvdaE', 'type': 'Starfish Reward 4', 'height': 69552507, 'included_in_block_hash': '6tzoqLVnyzWqe8cUk6Mp9QXP5N72Nn2B8LDWZejY5fy1', 'block_timestamp': 1657481386684222200, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '687920756129100000000'}, {'transaction_hash': '7r4yXfG762DYNSCNi36ErjAZH3ioF6DQfrdP9oXD8j1u', 'type': 'Starfish Reward 4', 'height': 69533007, 'included_in_block_hash': 'woWyq37hYeXf1aQBVShVmvB5fT4nUofSZTfqniAUMjd', 'block_timestamp': 1657458232171790300, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '849279749523100000000'}, {'transaction_hash': 'BUCzaLsXXpADFwT22gRDVLdHNAbL869pWvCaSZX4ouma', 'type': 'Transfer', 'height': 69515998, 'included_in_block_hash': '6ECAuw3QtQqgy7fF3e7iuzQHrEjL5ZBcdXVgvfckdzcQ', 'block_timestamp': 1657438016721255400, 'from': 'scarefacepmpdn.near', 'to': 'alvina88.near', 'deposit_value': '1.3421180726975e+25', 'transaction_fee': '44636512500000000000'}, {'transaction_hash': 'ErNoyhRAJT7162Cm983AZkcRqNZwQBvQXx5SkBDfojoa', 'type': 'Transfer', 'height': 69515970, 'included_in_block_hash': '3bGwn2fhv9paWgGYd11QBV3z4x59oiRpnHNzABsk1phv', 'block_timestamp': 1657437983922312000, 'from': 'scarefacepmpdn.near', 'to': 'dasha_domnear.near', 'deposit_value': '1.342123e+25', 'transaction_fee': '44636512500000000000'}, {'transaction_hash': '6c1haZ7gq4CoAypuY32dGhV7bM41aQi7rLNLyXCwSysE', 'type': 'Starfish Reward 4', 'height': 69486629, 'included_in_block_hash': '61piTmCYmqdXK9V6nhAcb5TUkX5c4QSL8jSbCYxiPPDR', 'block_timestamp': 1657403200638981600, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '781807729299900000000'}, {'transaction_hash': 'J9JqoPyuCEj3gQfAY37xkHMjTafTQtUhtVvtNf9wwRsb', 'type': 'Starfish Reward 4', 'height': 69485761, 'included_in_block_hash': '5Dy1GZdWEk3HdNz4xGzhNFSYSdgg4qVxdfUY7oqHQYf7', 'block_timestamp': 1657402154956597200, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '688049271003500000000'}, {'transaction_hash': '3na3Mxp2DaS5sjY7tCKQaizzbu6UWTEp8ftCnad58Dm4', 'type': 'Starfish Reward 4', 'height': 69481001, 'included_in_block_hash': 'GeHS6yLxwfHEJQCGx5cTNg5uSqLjcm2nct73b4uwVKpr', 'block_timestamp': 1657396424412764000, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '665086247906100000000'}, {'transaction_hash': 'FgmDNN74SEV1pZBRjrgKheMtF8XKStK9Ldq4mJJj1FvV', 'type': 'Starfish Reward 4', 'height': 69479549, 'included_in_block_hash': 'HcpmPPpjdTLpNv4o49ARjPDoPdA5Rv46wGLHh4bRGvue', 'block_timestamp': 1657394663086829000, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '687803225144100000000'}, {'transaction_hash': '24KrUTPBgx54AJBBCb4rHa2Qk6yPxWjg8Q2RBkhjpTBU', 'type': 'Starfish Reward 4', 'height': 69472545, 'included_in_block_hash': '764owmYGNNYVo1PLK7tdXDx43cyi8t2EDC2tjWiUUvcr', 'block_timestamp': 1657386456052955600, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '652238705652300000000'}, {'transaction_hash': '7s2TbyPAxmTMmngHst2xru5yfqRKksBLnaG1ehmPJyge', 'type': 'Starfish Reward 4', 'height': 69471966, 'included_in_block_hash': '4nv9xCu2VwqpPKDor7VLGP2X2SpjwvyqDuGnEuwn4XZ5', 'block_timestamp': 1657385776102544600, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '822597809558500000000'}, {'transaction_hash': 'FeHR8FG1pdxWxAmuzo3TGd4ekQW5yUHUsNK1w5AUC8Kc', 'type': 'Starfish Reward 4', 'height': 69460411, 'included_in_block_hash': 'Gd1zgGhg3rcMYroXBTP4Dh5BdT3XeZufGRfCDcypjLPL', 'block_timestamp': 1657372156343746600, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '781570980583300000000'}, {'transaction_hash': '63D3vTQ1xBzbNzB37gnmyJDXxdudG14w9ng85PLatrAA', 'type': 'Starfish Reward 4', 'height': 69458612, 'included_in_block_hash': 'DxK5rRtM97jvKrxuT7n8xnbxcoDE7dWXm9VQPpcyi96m', 'block_timestamp': 1657370045132096500, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '781088638426300000000'}, {'transaction_hash': 'YJ9Ti4k6cdmcNkX5QSA7DFykAkTBJ7qtQAhmGeKqnTx', 'type': 'Starfish Reward 4', 'height': 69457817, 'included_in_block_hash': 'FZh71fDhHZFWDD86oFNSPyYJMEJmTD4KT4E9crTihNec', 'block_timestamp': 1657369105904675800, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '687596548256100000000'}, {'transaction_hash': '39UBBBUKqL8KccR5fQQxEe4uPrFKBKk2nybkay5gUF5s', 'type': 'Starfish Reward 4', 'height': 69439102, 'included_in_block_hash': '9n4sRKKn5r2RNK4LTfQegkRHLGbh6XBwXCBdh3JD52cj', 'block_timestamp': 1657346632154916400, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '734655776283800000000'}, {'transaction_hash': '7xnvciMWRNg8kjzeS8R8wXD8iyoeNQsbcQQ21rUTseKP', 'type': 'Starfish Reward 4', 'height': 69432854, 'included_in_block_hash': '92pG89SXy1V7YsW46DEaEfDyHy3FzeuYHaDHvm7cKau6', 'block_timestamp': 1657339138383505000, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '733486060787400000000'}, {'transaction_hash': '5f4hbycA9mCHUQ2zcG7poKBs9ot54Mzb5am4Cs8zpHup', 'type': 'Starfish Reward 4', 'height': 69413009, 'included_in_block_hash': '8w9fWA2NrTCmQ1gqiVWKXVmvHTQBvGJornNaTCeW5iaS', 'block_timestamp': 1657315709917537300, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '698977675035800000000'}, {'transaction_hash': 'PmRLsM99YQ8ojtDuxVAREjSiGVDepbKGCpCfijVbQZM', 'type': 'Starfish Reward 4', 'height': 69408293, 'included_in_block_hash': 'GkS8aSsdd2vCccdYFbDSCoTihnFGmoJQAXefintsBytY', 'block_timestamp': 1657310061192464400, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '734380645903000000000'}, {'transaction_hash': 'DRYjR1ChXqjpRbUhfhEgD4AUnPD8dQZBFJYv7GNQTQey', 'type': 'Starfish Reward 4', 'height': 69406110, 'included_in_block_hash': '8QwYyEeLJCXyVyx5UqCtiF1zciYJdapeTVsK9UAvJLzQ', 'block_timestamp': 1657307428162237400, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '652104513761500000000'}, {'transaction_hash': 'Xyp56vyEGwXZ5qV5gUp6chbRVZPCpcCzuh5kxPtP5vJ', 'type': 'Starfish Reward 4', 'height': 69397410, 'included_in_block_hash': '88EEnMfNfgE4hPYVQsa93mF9sZfojXESSYt2BD6fkdNM', 'block_timestamp': 1657296913317988400, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '694119188776100000000'}, {'transaction_hash': 'Vfpqnx3afLPTDbvqZTnYABZYFWyVD5xL16yjXas8Gee', 'type': 'Starfish Reward 4', 'height': 69349419, 'included_in_block_hash': '2CyrwbWY5tEru2QL4Gd6x2MXSnsFaGGrzgUp4H6rKuX5', 'block_timestamp': 1657239333869591600, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '687930341333300000000'}, {'transaction_hash': 'ByGURGkFQKZ5tiYVCjxk2nr1gTEANPjMnnMsSZjxZVhu', 'type': 'Starfish Reward 4', 'height': 69339057, 'included_in_block_hash': '2xdmMgFLnq9rmah46e9rGJHeRSdf7ETJJCQHredR5361', 'block_timestamp': 1657226841201146600, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '687337337059900000000'}, {'transaction_hash': '8soKbo5AZvepoMHE92iRFfp661XgUAhdZc5vqM2W6Mmw', 'type': 'Starfish Reward 4', 'height': 69327334, 'included_in_block_hash': 'BLaEwwTXUZRLsiemAWiZVa2gkdvYKSWW93EAsbzmz6dF', 'block_timestamp': 1657212373938824400, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '745992719825500000000'}, {'transaction_hash': 'bjLfiH3FNB9YnX3znUE4y93u1cAgpKsoZ4zMUiQXYQZ', 'type': 'Starfish Reward 4', 'height': 69323571, 'included_in_block_hash': '6pCDnCPK3F1v9crFtRL2Rep1CsDCm5gF3emMPzs3uy5E', 'block_timestamp': 1657207683962185700, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '688443865942700000000'}, {'transaction_hash': 'H3HSSwcLKfTob7kdLfXNrotA6z2hgXu3JeErSYEfsRq7', 'type': 'Starfish Reward 4', 'height': 69320218, 'included_in_block_hash': 'GnSXHRAkg1SydHXcEZgy6TWCzhqXxx9sdgMbuprJ2eXb', 'block_timestamp': 1657203451892987000, 'from': 'app.nearcrowd.near', 'to': 'app.nearcrowd.near', 'deposit_value': '0', 'transaction_fee': '756446853783300000000'}]}
        ]
        self.nearblocks.request.side_effect = mocked_response
        txs = self.nearblocks.get_txs(address)
        expected_result = [{Currencies.near: {'address': 'scarefacepmpdn.near', 'hash': 'BUCzaLsXXpADFwT22gRDVLdHNAbL869pWvCaSZX4ouma', 'from_address': 'scarefacepmpdn.near', 'to_address': 'alvina88.near', 'amount': Decimal('-13.421180726975000000000000'), 'block': 69515998, 'date': datetime.datetime(2022, 7, 10, 7, 26, 56, 721256), 'confirmations': 55632, 'direction': 'outgoing', 'raw': ''}}, {Currencies.near: {'address': 'scarefacepmpdn.near', 'hash': 'ErNoyhRAJT7162Cm983AZkcRqNZwQBvQXx5SkBDfojoa', 'from_address': 'scarefacepmpdn.near', 'to_address': 'dasha_domnear.near', 'amount': Decimal('-13.421230000000000000000000'), 'block': 69515970, 'date': datetime.datetime(2022, 7, 10, 7, 26, 23, 922312), 'confirmations': 55660, 'direction': 'outgoing', 'raw': ''}}]
        assert len(txs) == 2
        assert expected_result == txs

    def test_get_txs_account_with_failed_batched_tx(self):
        address = 'cb26db54-35c2-4920-8b2f-5b3bb26fc15e.feiyu.near'
        mocked_response = [
            {'blocks': [{'block_height': 71103865, 'block_hash': '8YyhVTz6SMp4rmiwe2qgpyEhpNPqbd6kRoUjUjqB9xGu', 'block_timestamp': 1659364437106104300, 'txn': 4, 'receipt': 16, 'author': 'astro-stakers.poolv1.near', 'gas_used': 40688129463749, 'gas_limit': 4000000000000000, 'gas_fee': '4.0688129463749e+21'}]},
            {'txns': [{'transaction_hash': 'AAUhqs7Q8bknBWVoTHXbAPuKPA5MDLVmJHnQx5MwNSpj', 'type': 'Batch Transaction', 'height': 71093362, 'included_in_block_hash': '6tpAWdkSUPPryeKkEBhtCEztbJo7pw9L1U83NoeKdH67', 'block_timestamp': 1659351338552171000, 'from': 'feiyu.near', 'to': 'cb26db54-35c2-4920-8b2f-5b3bb26fc15e.feiyu.near', 'deposit_value': '1.82e+21', 'transaction_fee': '63222193750000000000'}, {'transaction_hash': 'HK3RQmwvoTD7LGk8iMQyc4YHLUbWwWB8S9m2oZsRexHJ', 'type': 'Batch Transaction', 'height': 71093359, 'included_in_block_hash': '2QeHdq385SYK14ZwXGDgTPrr2yrwhWKik8c84UCzzM3d', 'block_timestamp': 1659351334614349800, 'from': 'feiyu.near', 'to': 'cb26db54-35c2-4920-8b2f-5b3bb26fc15e.feiyu.near', 'deposit_value': '1.82e+21', 'transaction_fee': '84911012500000000000'}]}
        ]
        self.nearblocks.request.side_effect = mocked_response
        txs = self.nearblocks.get_txs(address)
        expected_result = []
        assert len(txs) == 0
        assert expected_result == txs

    def test_get_txs_account_with_contract_transfers(self):
        address = 'v2.ref-finance.near'
        mocked_response = [
            {'blocks': [{'block_height': 72192800, 'block_hash': '8BLWSJEExbpSoztaYbGfwAjjQvCZ8EjbfgyKrvhi9yd9', 'block_timestamp': 1660728054487511300, 'txn': 2, 'receipt': 13, 'author': 'continue.poolv1.near', 'gas_used': 68927158523648, 'gas_limit': 4000000000000000, 'gas_fee': '6.8927158523648e+21'}]},
            {'txns': [{'transaction_hash': '39fEZdEdWvJhgnTKXuZG8focEYXSAff6harS88rfzGkf', 'type': 'Batch Transaction', 'height': 72192809, 'included_in_block_hash': '9ZP4URPuZ122MneiaGmXBwJQVcA2nZXms7kBWPE25obe', 'block_timestamp': 1660728065040438500, 'from': 'twosteppedigital.near', 'to': 'v2.ref-finance.near', 'deposit_value': '2', 'transaction_fee': '2.5863943817681e+21'}, {'transaction_hash': '9FQnEW4yK3AUNa4ad77FLXHmA9STc8mZ3a1bSrRzkCrW', 'type': 'Mft Transfer Call', 'height': 72192776, 'included_in_block_hash': '4Was5p5ZecZDhZsnppPKDw8FfYtgxFuHJUzKFEiTiAua', 'block_timestamp': 1660728025809229300, 'from': 'cryptonum.near', 'to': 'v2.ref-finance.near', 'deposit_value': '1', 'transaction_fee': '2.1139350893575e+21'}, {'transaction_hash': '9fpeJcSG8BAawPCc9wDDXHM53H8L2DAFGa2HnXTv55f8', 'type': 'Get Deposits', 'height': 72192768, 'included_in_block_hash': 'GyiP9XweNcqhhNHzEaPkC9kf2Uh25RUeGf5JNos6oBaj', 'block_timestamp': 1660728016211158500, 'from': 'koreanb.near', 'to': 'v2.ref-finance.near', 'deposit_value': '1', 'transaction_fee': '779373088194600000000'}, {'transaction_hash': '4YPAUJ6tMuGZJa3f4DR2ocNQMjrRNaGmUxTsi3FV3ZzR', 'type': 'Withdraw Seed', 'height': 72192763, 'included_in_block_hash': 'EczNJWQJJL7cJ35M4q6q3rxXguboFkUddy421Y7G4SMn', 'block_timestamp': 1660728010521887700, 'from': 'cryptonum.near', 'to': 'v2.ref-farming.near', 'deposit_value': '1', 'transaction_fee': '2.7155491130203e+21'}, {'transaction_hash': '5JEbjeDeDweGQFtiQTqybXd8y7LZZEDXK3AHGc4n2ytX', 'type': 'Unlock And Withdraw Seed', 'height': 72192762, 'included_in_block_hash': 'B9QRAQTJeL5CjyjGnHFQPxmXB3bxC1ahKVwdjs54pqAD', 'block_timestamp': 1660728009402433500, 'from': 'twosteppedigital.near', 'to': 'boostfarm.ref-labs.near', 'deposit_value': '1', 'transaction_fee': '2.0893516177906e+21'}, {'transaction_hash': '54HzymdQwqMDdJuJFmjr2H73tu2VtPfdcXoVbesS11He', 'type': 'Ft Transfer Call', 'height': 72192739, 'included_in_block_hash': 'D2kQFjT2L9aqdJbTw9Bqw2tsy9pSqDZeZnNZFEoqjVqw', 'block_timestamp': 1660727981420279300, 'from': 'ndh0206.near', 'to': 'dac17f958d2ee523a2206206994597c13d831ec7.factory.bridge.near', 'deposit_value': '1', 'transaction_fee': '3.3218709919908e+21'}, {'transaction_hash': '2PoNJ5gwsazXnsqCbrmZKTTBDbYXqkyikL2dv1zkiwJR', 'type': 'Ft Transfer Call', 'height': 72192729, 'included_in_block_hash': '5XWWG5RKAMemtgGq4ep3TtpU9nRijnmcLZyx779jt9ZU', 'block_timestamp': 1660727969552707600, 'from': '9e674d8c4f93884de03fc009e2230e32fb11e99832a00de2f0df051e7158f703', 'to': 'wrap.near', 'deposit_value': '1', 'transaction_fee': '3.6131347545912e+21'}, {'transaction_hash': 'AoWvbMy3KiM9gPhMwQceMGN7zAdkDjvf5EXvrCx5QZqo', 'type': 'Add Stable Liquidity', 'height': 72192679, 'included_in_block_hash': 'GDuVHCEpVpuBAsBFrGwztEhKXrGqZLeHRb9UDgCcJTQM', 'block_timestamp': 1660727909448739000, 'from': 'a06e1fdd44aeccd751dffdf92ee4ea6bb4715f3c0336e09e39bc158d8e064c05', 'to': 'v2.ref-finance.near', 'deposit_value': '1e+22', 'transaction_fee': '1.1041149937842e+21'}, {'transaction_hash': 'B8uoAP1uZaCcen8LakBeVeKAafvJqNQDnhtPCxjFLPHj', 'type': 'Add Liquidity', 'height': 72192676, 'included_in_block_hash': '6oEdy9StSCge8p96LGzTvtw3WtWm7m1h1ATZggBEbLxM', 'block_timestamp': 1660727906124114000, 'from': 'ant3.near', 'to': 'v2.ref-finance.near', 'deposit_value': '1e+22', 'transaction_fee': '881583936647000000000'}, {'transaction_hash': '6FvLB2xbyBnQB5UojmmoTb9JN1bMWk8EKDjB3LthANZj', 'type': 'Ft Transfer Call', 'height': 72192672, 'included_in_block_hash': '7cHpqZwex5hBWK4vA2SurnH5iZdGMJXptoa2UiS2wqPt', 'block_timestamp': 1660727901609041200, 'from': 'a06e1fdd44aeccd751dffdf92ee4ea6bb4715f3c0336e09e39bc158d8e064c05', 'to': 'meta-pool.near', 'deposit_value': '1', 'transaction_fee': '2.2331730937992e+21'}, {'transaction_hash': 'BCdWxvZkR4VjotyiDHf296uAfo7o2xibAGujMCCQKNkQ', 'type': 'Ft Transfer Call', 'height': 72192669, 'included_in_block_hash': '4K2GnEmqQi5yRQc4ZrG4rLvQL4UTBMwcER8HB4F591Fr', 'block_timestamp': 1660727898107584800, 'from': 'ant3.near', 'to': 'celo.token.a11bd.near', 'deposit_value': '1', 'transaction_fee': '1.8579046022273e+21'}, {'transaction_hash': '58DRY6R6b9L8T22FaSmAZZgBZLv1RyGbYin2UB38pBdR', 'type': 'Ft Transfer Call', 'height': 72192665, 'included_in_block_hash': 'eTmTAkf3B2jLdX9ZE2mdbDGLXidRUjp4TvtqTTkKWdT', 'block_timestamp': 1660727893153287400, 'from': 'a06e1fdd44aeccd751dffdf92ee4ea6bb4715f3c0336e09e39bc158d8e064c05', 'to': 'wrap.near', 'deposit_value': '1', 'transaction_fee': '1.8556167990306e+21'}, {'transaction_hash': 'hd7mmfCzDrdrh4LhYapJQN9h1TLW57FQ7RhcM4ePZEA', 'type': 'Ft Transfer Call', 'height': 72192661, 'included_in_block_hash': '65rU1Ab4pjw5a2BFo8GAdjHT9ZgiJeKWLpwrRxEwUGTM', 'block_timestamp': 1660727888519504100, 'from': 'ant3.near', 'to': 'token.v2.ref-finance.near', 'deposit_value': '1', 'transaction_fee': '1.8899516879279e+21'}, {'transaction_hash': '2sypbCaqgfXSWdjN9UPUzTfK29S3ZkPCQhS1AvFbSXBx', 'type': 'Ft Transfer Call', 'height': 72192627, 'included_in_block_hash': '9UMWLhEQtoaF8P2BC7VyCxWBp63HdUTyfQhKAp12BCg9', 'block_timestamp': 1660727848155692300, 'from': '22cbf9172b7207e2e68321cccccaea12df30dff16e741892ca159736ec5bb9b0', 'to': 'wrap.near', 'deposit_value': '1', 'transaction_fee': '3.3494636217367e+21'}, {'transaction_hash': '42FgaQC38DCuLbYmPPBQ3VczK4K6s8d97FJDF4VGaPKs', 'type': 'Ft Transfer Call', 'height': 72192620, 'included_in_block_hash': '66LKsWprtukguPgXkMrg4HKCSNGDkLZJPj7SBH4zAkWT', 'block_timestamp': 1660727839684932400, 'from': '7c5206b1b75b8787420b09d8697e08180cdf896c5fcf15f6afbf5f33fcc3cf72', 'to': 'aurora', 'deposit_value': '1', 'transaction_fee': '3.3651775861229e+21'}, {'transaction_hash': '9iXZH6WRTn77ECa5Kun2AwZUvYY2RDsFcny6r7QhBsTH', 'type': 'Ft Transfer Call', 'height': 72192544, 'included_in_block_hash': 'G6t7FbVH1c6iWhTTxa8mGztBwJ7kn5xftRXtYDMw3WL6', 'block_timestamp': 1660727746111497700, 'from': 'hero77.near', 'to': 'pixeltoken.near', 'deposit_value': '1', 'transaction_fee': '4.3191081119463e+21'}, {'transaction_hash': 'CCausBA6KwXjTuJQ4yzUTHat2sZH2jDjDMt1G4s34EDT', 'type': 'Mft Transfer Call', 'height': 72192534, 'included_in_block_hash': '9NHN1otUK4YgFAbwEt9BeexZxt4M9aVyLow1kB9j8Ld6', 'block_timestamp': 1660727732842473200, 'from': 'jockowy.near', 'to': 'v2.ref-finance.near', 'deposit_value': '1', 'transaction_fee': '2.1414421256633e+21'}, {'transaction_hash': 'H7Fo2AY9VaAqmyZwS4bH69oK8KaMQvPPUJXaWeSemtTi', 'type': 'Withdraw Seed', 'height': 72192527, 'included_in_block_hash': '3YSq2Fpja8H1RJiJjadWb9hzRnK1s8ChzrMwV226krQ9', 'block_timestamp': 1660727723735521300, 'from': 'jockowy.near', 'to': 'v2.ref-farming.near', 'deposit_value': '1', 'transaction_fee': '3.8566549560737e+21'}, {'transaction_hash': 'FcgNHQDkgFEcpVE6QEuvqu9JGAH1GLzQSyv5V54eRdZ5', 'type': 'Swap', 'height': 72192521, 'included_in_block_hash': 'EGcfjCFfLEQxLoh6UqzNvusfTKR9otzBjJmqXPoqVgN6', 'block_timestamp': 1660727715985977000, 'from': 'pizzamaker.near', 'to': 'v2.ref-finance.near', 'deposit_value': '1', 'transaction_fee': '1.377401234011e+21'}, {'transaction_hash': '7yC7sTY4q5esaTDK5B4q6vE76Ws5vzwWofs1iuJt56RF', 'type': 'Swap', 'height': 72192521, 'included_in_block_hash': 'EGcfjCFfLEQxLoh6UqzNvusfTKR9otzBjJmqXPoqVgN6', 'block_timestamp': 1660727715985977000, 'from': 'tradersieucapvodichvipro.near', 'to': 'v2.ref-finance.near', 'deposit_value': '1', 'transaction_fee': '1.4635112395536e+21'}, {'transaction_hash': 'BodsBg5o6dAu72v4HD2Yh9rTGveypGzLuNHpReS4jDHE', 'type': 'Swap', 'height': 72192521, 'included_in_block_hash': 'EGcfjCFfLEQxLoh6UqzNvusfTKR9otzBjJmqXPoqVgN6', 'block_timestamp': 1660727715985977000, 'from': 'pizzamaker.near', 'to': 'v2.ref-finance.near', 'deposit_value': '1', 'transaction_fee': '1.377401234011e+21'}, {'transaction_hash': 'GTbUjzG2rp82g5EdMAgAwvHWmhFkTxZPUR1iwzWFJuVD', 'type': 'Swap', 'height': 72192521, 'included_in_block_hash': 'EGcfjCFfLEQxLoh6UqzNvusfTKR9otzBjJmqXPoqVgN6', 'block_timestamp': 1660727715985977000, 'from': 'pizzamaker.near', 'to': 'v2.ref-finance.near', 'deposit_value': '1', 'transaction_fee': '1.5197673800488e+21'}, {'transaction_hash': 'BRykKtuVcHcMcNDKTnHz2vjfpnM3BQLoFxyWQoHp9syJ', 'type': 'Swap', 'height': 72192519, 'included_in_block_hash': '22NqkwXZKUHiMhi5NyL332vZ4cGhE2YXgGzT26sQDNmL', 'block_timestamp': 1660727713143572500, 'from': 'sneaky1.near', 'to': 'v2.ref-finance.near', 'deposit_value': '0', 'transaction_fee': '1.976838929578e+21'}, {'transaction_hash': '91KASrfuM9u8N3mJ7zWcTmVBzwbrEw3gfrffHKZtxUN', 'type': 'Swap', 'height': 72192519, 'included_in_block_hash': '22NqkwXZKUHiMhi5NyL332vZ4cGhE2YXgGzT26sQDNmL', 'block_timestamp': 1660727713143572500, 'from': 'aldor.near', 'to': 'v2.ref-finance.near', 'deposit_value': '0', 'transaction_fee': '1.6144676180503e+21'}, {'transaction_hash': 'BQEJpbVVdrzCxE6yEE3NwE9X6Qi2r14pFtGYrjEa3VvA', 'type': 'Ft Transfer Call', 'height': 72192517, 'included_in_block_hash': 'Eib9pfJTNPJETqaUT2nxDruky1RnfVbVscb45NkjC8Kh', 'block_timestamp': 1660727710612438300, 'from': 'nnvl1992.near', 'to': 'meta-pool.near', 'deposit_value': '1', 'transaction_fee': '4.092811673239e+21'}]}
        ]
        self.nearblocks.request.side_effect = mocked_response
        txs = self.nearblocks.get_txs(address)
        expected_result = []
        assert expected_result == txs

    def test_get_contract_tx_details_with_not_valid_token_transfer(self):
        tx_hash = 'FpzDaZNBgMrsQjmiKs7GV2tods8v6gohfhXCaUGFRpb'
        mocked_response = [
            {'txn': {'transaction_hash': 'FpzDaZNBgMrsQjmiKs7GV2tods8v6gohfhXCaUGFRpb', 'status': 'Succeeded', 'height': 72182320, 'included_in_block_hash': 'A1XneVUvJGRrhRQqTEDTGad9bXaMmobaymKt97gfQkg', 'block_timestamp': 1660715343990257200, 'from': 'hanquocj.near', 'to': 'v2.ref-finance.near', 'deposit_value': '1', 'transaction_fee': '944457514495100000000', 'gas_limit': '100000000000000', 'gas_used': '9667757707451', 'burnt_gas': 2428017145162, 'tokens_burnt': 242801714516200000000}},
        ]
        self.nearblocks.request.side_effect = mocked_response
        tx_detail = self.nearblocks.get_tx_details(tx_hash)
        expected_result = {'success': False}
        assert tx_detail == expected_result

    def test_get_tx_details(self):
        tx_hash = '3mRNgeVjt6PnHVbrTyxff5XNeuPGaCKP1YzkfNfKaq7E'
        mocked_response = [
            {'txn': {'transaction_hash': '3mRNgeVjt6PnHVbrTyxff5XNeuPGaCKP1YzkfNfKaq7E', 'status': 'Succeeded', 'height': 69168199, 'included_in_block_hash': 'ARCTEZ5sCg9Py9KbKVR4aaNMrUtpkLRpU7muFXHg1FkT', 'block_timestamp': 1657008578119042300, 'from': 'kingjav.near', 'to': 'c9cfdd8433e6c276505c7cab7f8bcc7d8bfdeb0145a107ae36791335d9200522', 'deposit_value': '1.13316661523073922e+25', 'transaction_fee': '84911012500000000000', 'gas_limit': '1072292687500', 'gas_used': '1072292687500', 'burnt_gas': 424555062500, 'tokens_burnt': 42455506250000000000}},
            {'blocks': [{'block_height': 69577178, 'block_hash': '5J5DTbkJddaY59YvxqAGEbDTBr7NoN2moKSQ2i6wKiTQ', 'block_timestamp': 1657510477833865200, 'txn': 1, 'receipt': 2, 'author': 'rekt.poolv1.near', 'gas_used': 8625255575027, 'gas_limit': 4000000000000000, 'gas_fee': '862525557502700000000'}]}
        ]
        self.nearblocks.request.side_effect = mocked_response
        tx_detail = self.nearblocks.get_tx_details(tx_hash)
        expected_result = {'hash': '3mRNgeVjt6PnHVbrTyxff5XNeuPGaCKP1YzkfNfKaq7E', 'success': True, 'inputs': [], 'outputs': [], 'transfers': [{'type': '', 'symbol': 'NEAR', 'currency': Currencies.near, 'from': 'kingjav.near', 'to': 'c9cfdd8433e6c276505c7cab7f8bcc7d8bfdeb0145a107ae36791335d9200522', 'value': Decimal('11.331666152307392200000000'), 'is_valid': True}], 'block': 69168199, 'confirmations': 408979, 'fees': Decimal('0.000084911012500000000000'), 'date': datetime.datetime(2022, 7, 5, 8, 9, 38, 119042), 'raw': ''}
        assert tx_detail == expected_result

    def test_get_failed_contract_tx_details(self):
        tx_hash = 'Hujm9zxheRrdiqub4CjskCo8BcxTfcc9kguAffX4MFah'
        mocked_response = [
            {'txn': {'transaction_hash': 'Hujm9zxheRrdiqub4CjskCo8BcxTfcc9kguAffX4MFah', 'status': 'Failed',
                     'height': 70345508, 'included_in_block_hash': '7Fcg9TC8qziWmiqw85BzqptYNTxphE2bfShKMpLFXU4a',
                     'block_timestamp': 1658427755576584200, 'from': 'relay.aurora', 'to': 'aurora',
                     'deposit_value': '0', 'transaction_fee': '580452514413900000000', 'gas_limit': '300000000000000',
                     'gas_used': '6027707706639', 'burnt_gas': 2428323468120, 'tokens_burnt': 242832346812000000000}}
        ]
        self.nearblocks.request.side_effect = mocked_response
        tx_detail = self.nearblocks.get_tx_details(tx_hash)
        expected_result = {'success': False}
        assert tx_detail == expected_result

    def test_get_failed_transfer_tx_details(self):
        tx_hash = 'AbsXYZRtjSsREtEwFyHugEHZzMsPjm9uBSAdJ7BDY3Ma'
        mocked_response = [
            {'txn': {'transaction_hash': 'AbsXYZRtjSsREtEwFyHugEHZzMsPjm9uBSAdJ7BDY3Ma', 'status': 'Failed', 'height': 69446727, 'included_in_block_hash': 'EnuhPmm6ByeGd5BZbLY2HSsS8gtMhM3fqdwRkBRYi4gh', 'block_timestamp': 1657355799415925800, 'from': '0bbe847c6734e1bbeb3d70ecd6fc07d2adf8c48ee27df84b9f3f2327b06d0001', 'to': 'sigma-979215773648417.near', 'deposit_value': '61109700000000000000', 'transaction_fee': '44636512500000000000', 'gas_limit': '1295475250000', 'gas_used': '1295475250000', 'burnt_gas': 223182562500, 'tokens_burnt': 22318256250000000000}}
        ]
        self.nearblocks.request.side_effect = mocked_response
        tx_detail = self.nearblocks.get_tx_details(tx_hash)
        expected_result = {'success': False}
        assert tx_detail == expected_result

    def test_validate_address(self):
        assert self.nearblocks.validate_address('scarefacepmpdn.near')
        assert self.nearblocks.validate_address('1f921e546971e2eed170f438506069ccbc96c9a98ddf622a3ba42582f9d2464c')
        assert not self.nearblocks.validate_address('1f921e546971e2eed170f438506069ccbc96c9a98ddf622a3ba42582f9d2464')
        assert not self.nearblocks.validate_address('1f921e546971e2eed170f438506069ccbc96c9a98ddf622a3ba42582f9d246-c')
        assert not self.nearblocks.validate_address('1f921e546971e2eed170f438506069ccbc96c9a98ddf622a3ba42582f9d2464c2')
