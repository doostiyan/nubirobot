import unittest
from decimal import Decimal
from json import JSONDecodeError
from unittest.mock import Mock

from exchange.base.models import Currencies
from exchange.blockchain.api.near.near_nearscan import NearScan


class TestNearScan(unittest.TestCase):
    nearscan = NearScan()
    nearscan.request = Mock()

    def test_get_block_head(self):
        mocked_response = [{'hash': 'GMvS4XZVoXp5AsyJ3pwC5mA1PGN3EAWgMLkgZgC3rUmN', 'height': '70457818', 'author': 'blockdaemon.poolv1.near', 'timestamp': '1658563958015', 'prev_hash': '4ky7fDhqxR9E9MptV4mmkBZjLhgf4MAweFsHVyKxqtgL', 'transactions_count': '5'}, {'hash': '4ky7fDhqxR9E9MptV4mmkBZjLhgf4MAweFsHVyKxqtgL', 'height': '70457817', 'author': 'nearfans.poolv1.near', 'timestamp': '1658563956815', 'prev_hash': 'qDgDuLbzp4pUsWZBN5mVCEXa9Zd3LpaY7pRvdt2kSJ7', 'transactions_count': '4'}, {'hash': 'qDgDuLbzp4pUsWZBN5mVCEXa9Zd3LpaY7pRvdt2kSJ7', 'height': '70457816', 'author': 'lux.poolv1.near', 'timestamp': '1658563955510', 'prev_hash': '6JzGjwMGh3QGEjdBUfRh6deGwu6WKwsg3ntrD41XvMY7', 'transactions_count': '9'}, {'hash': '6JzGjwMGh3QGEjdBUfRh6deGwu6WKwsg3ntrD41XvMY7', 'height': '70457815', 'author': 'bzam6yjpnfnxsdmjf6pw.poolv1.near', 'timestamp': '1658563954130', 'prev_hash': 'DmqQPYUtJNrSYQqXyXQFwwhtsY6wsd4YJTTVAiSFHBpR', 'transactions_count': '4'}, {'hash': 'DmqQPYUtJNrSYQqXyXQFwwhtsY6wsd4YJTTVAiSFHBpR', 'height': '70457814', 'author': 'future_is_near.poolv1.near', 'timestamp': '1658563952866', 'prev_hash': 'Fs6ukAkGMgJA59hMzRYq3WiuLQj6NMpjEborR4VWR3uU', 'transactions_count': '4'}, {'hash': 'Fs6ukAkGMgJA59hMzRYq3WiuLQj6NMpjEborR4VWR3uU', 'height': '70457813', 'author': 'stake1.poolv1.near', 'timestamp': '1658563951689', 'prev_hash': '7kKyXcuAmc2J7U9QqBqrpoKHoKxVNYwbbVMDiKQ636nB', 'transactions_count': '4'}, {'hash': '7kKyXcuAmc2J7U9QqBqrpoKHoKxVNYwbbVMDiKQ636nB', 'height': '70457812', 'author': 'foundry.poolv1.near', 'timestamp': '1658563950565', 'prev_hash': 'GVLk8nqF5gyfpFzgJL9gu67sgDZcPAhSMRAT9P1eJt3U', 'transactions_count': '4'}, {'hash': 'GVLk8nqF5gyfpFzgJL9gu67sgDZcPAhSMRAT9P1eJt3U', 'height': '70457811', 'author': 'bzam6yjpnfnxsdmjf6pw.poolv1.near', 'timestamp': '1658563949368', 'prev_hash': 'Htz9MVgvaVWoHEtHvb1WFFHuDq9PERkWw29k5crXgWu3', 'transactions_count': '1'}, {'hash': 'Htz9MVgvaVWoHEtHvb1WFFHuDq9PERkWw29k5crXgWu3', 'height': '70457810', 'author': 'chorusone.poolv1.near', 'timestamp': '1658563948239', 'prev_hash': '2cAWih3ZLqjh2vj9f9dNK2JAwxd4gBvSmntsD4SRDYjk', 'transactions_count': '5'}, {'hash': '2cAWih3ZLqjh2vj9f9dNK2JAwxd4gBvSmntsD4SRDYjk', 'height': '70457809', 'author': 'valisaurus-dex.poolv1.near', 'timestamp': '1658563947205', 'prev_hash': '3rQMMbSpeNB9pggSGifhEmgUEoQa9M6NQSLEtvgBT8Lt', 'transactions_count': '3'}]
        self.nearscan.request.return_value = mocked_response
        block_height = self.nearscan.get_block_head()
        assert block_height == 70457818

    def test_get_block_transactions(self):
        mocked_response = {'hash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'height': '71902391', 'author': 'dragonfly.poolv1.near', 'timestamp': '1660378507566', 'prev_hash': '5CD7nN1GfUW8t1YNxfbo2nfoDrPHHXGSJiaJyfCo8T2A', 'transactions': [{'hash': 'GPkrFojX2jgDe72E8qSNiujJFd9cbjCCJcjR2yM6CYYn', 'signerId': 'relay.aurora', 'receiverId': 'aurora', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 1, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 300000000000000, 'deposit': '0', 'method_name': 'submit', 'args': '+IuDFRSZgIMBFZiUGK/DiyUim3l+KvR7UFal+YJJ7xKApIK468cAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABfU9noScioLHoE2r76Ql7E0G57D2z+fCylJP2Rim02tZf/gQK4FDCEYGoAcKdk4jjCgtaw429VNeKccA2gNwhaEKu7sYRpUTmrow'}}]}, {'hash': '3b7HA3CWu4VVuTPFMd8LonBv4icF9oBXaZ4S4JF2zu7H', 'signerId': 'andrey1962.near', 'receiverId': 'app.nearcrowd.near', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 1, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 30000000000000, 'deposit': '0', 'method_name': 'claim_assignment', 'args': 'eyJ0YXNrX29yZGluYWwiOjEsImJpZCI6IjMyODU3NzIxMDAwNjkwMjIzMzYwOTUyIn0='}}]}, {'hash': 'EYf7MFDneobGfVWXwjJGbc7gSJWsafUbPxfap5BVBVx', 'signerId': 'eb3c2bfd6bf357f433be30292d78b23f948ee75f63baca2cc5f56cff1751c294', 'receiverId': 'e9b2fd9f3a6280ab37f6ce6909f4487aa86e76be3627c83583c0c69a11dd0fe1', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 0, 'actions': [{'kind': 'Transfer', 'args': {'deposit': '999000000000000000000000'}}]}, {'hash': 'Fk1NfiSU6VFBhMiNKhhdkFoBo3GsyeUHWd5pQ17AUAF9', 'signerId': 'sweat_welcome.near', 'receiverId': 'ff9a4f8786622c52def096128f1622c990254fdb3f036cc62982af82159d7dab', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 0, 'actions': [{'kind': 'Transfer', 'args': {'deposit': '50000000000000000000000'}}]}, {'hash': 'F3sxFHETMvwd2Tz9eyh4aLnxCvtTL5TNuC3KCfo13BFW', 'signerId': 'app.nearcrowd.near', 'receiverId': 'app.nearcrowd.near', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 0, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 200000000000000, 'deposit': '0', 'method_name': 'return_assignment_admin', 'args': 'eyJ0YXNrX29yZGluYWwiOjEsImFjY291bnRfaWQiOiI1N2ZmMzNjMDFmODMwZTNhY2E1ZTU4ZTk5YTI2MGRlZTdmNzQ5Yjg4OThhOTkzMjVhZTkzNTU0ZDEwYjMwNTYwIn0='}}]}]}
        self.nearscan.request.return_value = mocked_response
        txs = self.nearscan.get_block_transactions(71902391)
        assert txs == [{'hash': 'GPkrFojX2jgDe72E8qSNiujJFd9cbjCCJcjR2yM6CYYn', 'signerId': 'relay.aurora', 'receiverId': 'aurora', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 1, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 300000000000000, 'deposit': '0', 'method_name': 'submit', 'args': '+IuDFRSZgIMBFZiUGK/DiyUim3l+KvR7UFal+YJJ7xKApIK468cAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABfU9noScioLHoE2r76Ql7E0G57D2z+fCylJP2Rim02tZf/gQK4FDCEYGoAcKdk4jjCgtaw429VNeKccA2gNwhaEKu7sYRpUTmrow'}}]}, {'hash': '3b7HA3CWu4VVuTPFMd8LonBv4icF9oBXaZ4S4JF2zu7H', 'signerId': 'andrey1962.near', 'receiverId': 'app.nearcrowd.near', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 1, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 30000000000000, 'deposit': '0', 'method_name': 'claim_assignment', 'args': 'eyJ0YXNrX29yZGluYWwiOjEsImJpZCI6IjMyODU3NzIxMDAwNjkwMjIzMzYwOTUyIn0='}}]}, {'hash': 'EYf7MFDneobGfVWXwjJGbc7gSJWsafUbPxfap5BVBVx', 'signerId': 'eb3c2bfd6bf357f433be30292d78b23f948ee75f63baca2cc5f56cff1751c294', 'receiverId': 'e9b2fd9f3a6280ab37f6ce6909f4487aa86e76be3627c83583c0c69a11dd0fe1', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 0, 'actions': [{'kind': 'Transfer', 'args': {'deposit': '999000000000000000000000'}}]}, {'hash': 'Fk1NfiSU6VFBhMiNKhhdkFoBo3GsyeUHWd5pQ17AUAF9', 'signerId': 'sweat_welcome.near', 'receiverId': 'ff9a4f8786622c52def096128f1622c990254fdb3f036cc62982af82159d7dab', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 0, 'actions': [{'kind': 'Transfer', 'args': {'deposit': '50000000000000000000000'}}]}, {'hash': 'F3sxFHETMvwd2Tz9eyh4aLnxCvtTL5TNuC3KCfo13BFW', 'signerId': 'app.nearcrowd.near', 'receiverId': 'app.nearcrowd.near', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 0, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 200000000000000, 'deposit': '0', 'method_name': 'return_assignment_admin', 'args': 'eyJ0YXNrX29yZGluYWwiOjEsImFjY291bnRfaWQiOiI1N2ZmMzNjMDFmODMwZTNhY2E1ZTU4ZTk5YTI2MGRlZTdmNzQ5Yjg4OThhOTkzMjVhZTkzNTU0ZDEwYjMwNTYwIn0='}}]}]

    def test_get_latest_block(self):
        mocked_response = [
            {'hash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'height': '71902391', 'author': 'dragonfly.poolv1.near', 'timestamp': '1660378507566', 'prev_hash': '5CD7nN1GfUW8t1YNxfbo2nfoDrPHHXGSJiaJyfCo8T2A', 'transactions': [{'hash': 'GPkrFojX2jgDe72E8qSNiujJFd9cbjCCJcjR2yM6CYYn', 'signerId': 'relay.aurora', 'receiverId': 'aurora', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 1, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 300000000000000, 'deposit': '0', 'method_name': 'submit', 'args': '+IuDFRSZgIMBFZiUGK/DiyUim3l+KvR7UFal+YJJ7xKApIK468cAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABfU9noScioLHoE2r76Ql7E0G57D2z+fCylJP2Rim02tZf/gQK4FDCEYGoAcKdk4jjCgtaw429VNeKccA2gNwhaEKu7sYRpUTmrow'}}]}, {'hash': '3b7HA3CWu4VVuTPFMd8LonBv4icF9oBXaZ4S4JF2zu7H', 'signerId': 'andrey1962.near', 'receiverId': 'app.nearcrowd.near', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 1, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 30000000000000, 'deposit': '0', 'method_name': 'claim_assignment', 'args': 'eyJ0YXNrX29yZGluYWwiOjEsImJpZCI6IjMyODU3NzIxMDAwNjkwMjIzMzYwOTUyIn0='}}]}, {'hash': 'EYf7MFDneobGfVWXwjJGbc7gSJWsafUbPxfap5BVBVx', 'signerId': 'eb3c2bfd6bf357f433be30292d78b23f948ee75f63baca2cc5f56cff1751c294', 'receiverId': 'e9b2fd9f3a6280ab37f6ce6909f4487aa86e76be3627c83583c0c69a11dd0fe1', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 0, 'actions': [{'kind': 'Transfer', 'args': {'deposit': '999000000000000000000000'}}]}, {'hash': 'Fk1NfiSU6VFBhMiNKhhdkFoBo3GsyeUHWd5pQ17AUAF9', 'signerId': 'sweat_welcome.near', 'receiverId': 'ff9a4f8786622c52def096128f1622c990254fdb3f036cc62982af82159d7dab', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 0, 'actions': [{'kind': 'Transfer', 'args': {'deposit': '50000000000000000000000'}}]}, {'hash': 'F3sxFHETMvwd2Tz9eyh4aLnxCvtTL5TNuC3KCfo13BFW', 'signerId': 'app.nearcrowd.near', 'receiverId': 'app.nearcrowd.near', 'blockHash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'blockTimestamp': 1660378507566, 'transactionIndex': 0, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 200000000000000, 'deposit': '0', 'method_name': 'return_assignment_admin', 'args': 'eyJ0YXNrX29yZGluYWwiOjEsImFjY291bnRfaWQiOiI1N2ZmMzNjMDFmODMwZTNhY2E1ZTU4ZTk5YTI2MGRlZTdmNzQ5Yjg4OThhOTkzMjVhZTkzNTU0ZDEwYjMwNTYwIn0='}}]}]},
            {'hash': 'BQWAaQ6HKAbZNqLHPFRYxJAhnUA21pdzoFVPTdWXmtKN', 'height': '71902392', 'author': 'bzam6yjpnfnxsdmjf6pw.poolv1.near', 'timestamp': '1660378508665', 'prev_hash': 'BHZEPqAEg3PRZQGg1nbpEbhHbY4GXd78aHrjDFLuzfL8', 'transactions': [{'hash': 'fUGeMbzDejUhCAbi38pyQknJCVjJsr1wwQ8SQEBqLBt', 'signerId': '073.near', 'receiverId': 'app.nearcrowd.near', 'blockHash': 'BQWAaQ6HKAbZNqLHPFRYxJAhnUA21pdzoFVPTdWXmtKN', 'blockTimestamp': 1660378508665, 'transactionIndex': 0, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 80000000000000, 'deposit': '0', 'method_name': 'submit_review', 'args': 'eyJ0YXNrX29yZGluYWwiOjEsImFwcHJvdmUiOmZhbHNlLCJyZWplY3Rpb25fcmVhc29uIjoiMtCxIC0g0L3QtdGCINC40L3QvtC/0LvQsNC90LXRgtGP0L3QuNC90LAifQ=='}}]}, {'hash': 'Epm7uAMAFMj2Lapic7ExdExXS3PX2wSdXXoFbwGVL9Gd', 'signerId': 'sweat_welcome.near', 'receiverId': '8cd58b2a8784129021715646759cc57f498910a7fec47820e635bb7cbd9fb43e', 'blockHash': 'BQWAaQ6HKAbZNqLHPFRYxJAhnUA21pdzoFVPTdWXmtKN', 'blockTimestamp': 1660378508665, 'transactionIndex': 0, 'actions': [{'kind': 'Transfer', 'args': {'deposit': '50000000000000000000000'}}]}]},
            {'hash': 'Hhb4d2YojQdvHcrKTEsrZnpVwW5JpE8cjBGycvuW1kN7', 'height': '71902393', 'author': 'astro-stakers.poolv1.near', 'timestamp': '1660378509917', 'prev_hash': 'BQWAaQ6HKAbZNqLHPFRYxJAhnUA21pdzoFVPTdWXmtKN', 'transactions': [{'hash': '2J9ELJFnUvHj42w4Fp9gWWMvrHnrhb4ccPsb6u6YcqEm', 'signerId': 'pmh28.near', 'receiverId': 'aaaaaa20d9e0e2461697782ef11675f668207961.factory.bridge.near', 'blockHash': 'Hhb4d2YojQdvHcrKTEsrZnpVwW5JpE8cjBGycvuW1kN7', 'blockTimestamp': 1660378509917, 'transactionIndex': 0, 'actions': [{'kind': 'FunctionCall', 'args': {'gas': 100000000000000, 'deposit': '1', 'method_name': 'ft_transfer_call', 'args': 'eyJyZWNlaXZlcl9pZCI6InYxLm9yZGVyYm9vay5uZWFyIiwiYW1vdW50IjoiMTUzMjUwMDAwMDAwMDAwMDAwMDAiLCJtc2ciOiIifQ=='}}]}]},
            ]
        self.nearscan.request.side_effect = mocked_response
        expected_results = ({'input_addresses': {'eb3c2bfd6bf357f433be30292d78b23f948ee75f63baca2cc5f56cff1751c294'}, 'output_addresses': {'e9b2fd9f3a6280ab37f6ce6909f4487aa86e76be3627c83583c0c69a11dd0fe1'}}, {'outgoing_txs': {'eb3c2bfd6bf357f433be30292d78b23f948ee75f63baca2cc5f56cff1751c294': {Currencies.near: [{'tx_hash': 'EYf7MFDneobGfVWXwjJGbc7gSJWsafUbPxfap5BVBVx', 'value': Decimal('0.999000000000000000000000')}]}}, 'incoming_txs': {'e9b2fd9f3a6280ab37f6ce6909f4487aa86e76be3627c83583c0c69a11dd0fe1': {Currencies.near: [{'tx_hash': 'EYf7MFDneobGfVWXwjJGbc7gSJWsafUbPxfap5BVBVx', 'value': Decimal('0.999000000000000000000000')}]}}}, 71902393)
        results = self.nearscan.get_latest_block(71902390, 71902393, True, True)
        assert results == expected_results

    def test_get_non_existing_block_transactions(self):
        self.nearscan.request.side_effect = [JSONDecodeError('', '', 0)]
        txs = self.nearscan.get_block_transactions(71615401)
        assert txs == []
