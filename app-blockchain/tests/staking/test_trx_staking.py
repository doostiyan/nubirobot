from decimal import Decimal
from unittest import TestCase
from unittest.mock import Mock

from exchange.blockchain.api.trx.tronscan import TronscanAPI
from exchange.blockchain.staking.staking_interface import StakingInterface


class TrxStakingMockTest(TestCase):
    addresses = ['TLfJspfNmY77ZnWSXgFCAanKo5ApxXKBse']

    def test_get_staking_info(self):
        api = TronscanAPI.get_api()
        api.request = Mock()
        responses = [{'trc20token_balances': [], 'transactions_out': 3, 'acquiredDelegateFrozenForBandWidth': 0, 'rewardNum': 95962337, 'ownerPermission': {'keys': [{'address': 'TLfJspfNmY77ZnWSXgFCAanKo5ApxXKBse', 'weight': 1}], 'threshold': 1, 'permission_name': 'owner'}, 'tokenBalances': [{'amount': '103.575350', 'tokenPriceInTrx': 1, 'tokenId': '_', 'balance': '103575350', 'tokenName': 'trx', 'tokenDecimal': 6, 'tokenAbbr': 'trx', 'tokenCanShow': 1, 'tokenType': 'trc10', 'vip': False, 'tokenLogo': 'https://static.tronscan.org/production/logo/trx.png'}, {'tokenId': '1004787', 'tokenName': 'HIDEUSDT', 'owner_address': 'TDVSTbR5eLVTpSZVdvpqibnj8czYgr9fti', 'tokenAbbr': 'HIDEUSDT', 'tokenCanShow': 2, 'transferCount': 833252, 'tokenLogo': 'https://static.tronscan.org/production/upload/logo/1004787.png?t=1651892196849', 'nrOfTokenHolders': 832617, 'balance': '1688888', 'tokenDecimal': 6, 'tokenType': 'trc10', 'vip': False}], 'delegateFrozenForEnergy': 0, 'balances': [{'amount': '103.575350', 'tokenPriceInTrx': 1, 'tokenId': '_', 'balance': '103575350', 'tokenName': 'trx', 'tokenDecimal': 6, 'tokenAbbr': 'trx', 'tokenCanShow': 1, 'tokenType': 'trc10', 'vip': False, 'tokenLogo': 'https://static.tronscan.org/production/logo/trx.png'}, {'tokenId': '1004787', 'tokenName': 'HIDEUSDT', 'owner_address': 'TDVSTbR5eLVTpSZVdvpqibnj8czYgr9fti', 'tokenAbbr': 'HIDEUSDT', 'tokenCanShow': 2, 'transferCount': 833252, 'tokenLogo': 'https://static.tronscan.org/production/upload/logo/1004787.png?t=1651892196849', 'nrOfTokenHolders': 832617, 'balance': '1688888', 'tokenDecimal': 6, 'tokenType': 'trc10', 'vip': False}], 'trc721token_balances': [], 'balance': 103575350, 'voteTotal': 7000, 'totalFrozen': 7000000000, 'tokens': [{'amount': '103.575350', 'tokenPriceInTrx': 1, 'tokenId': '_', 'balance': '103575350', 'tokenName': 'trx', 'tokenDecimal': 6, 'tokenAbbr': 'trx', 'tokenCanShow': 1, 'tokenType': 'trc10', 'vip': False, 'tokenLogo': 'https://static.tronscan.org/production/logo/trx.png'}, {'tokenId': '1004787', 'tokenName': 'HIDEUSDT', 'owner_address': 'TDVSTbR5eLVTpSZVdvpqibnj8czYgr9fti', 'tokenAbbr': 'HIDEUSDT', 'tokenCanShow': 2, 'transferCount': 833252, 'tokenLogo': 'https://static.tronscan.org/production/upload/logo/1004787.png?t=1651892196849', 'nrOfTokenHolders': 832617, 'balance': '1688888', 'tokenDecimal': 6, 'tokenType': 'trc10', 'vip': False}], 'delegated': {}, 'transactions_in': 73, 'totalTransactionCount': 80, 'representative': {'lastWithDrawTime': 1661598546000, 'allowance': 0, 'enabled': False, 'url': ''}, 'frozenForBandWidth': 7000000000, 'reward': 1, 'addressTagLogo': '', 'allowExchange': [], 'address': 'TLfJspfNmY77ZnWSXgFCAanKo5ApxXKBse', 'frozen_supply': [], 'bandwidth': {'energyRemaining': 0, 'totalEnergyLimit': 90000000000, 'totalEnergyWeight': 3838221983, 'netUsed': 0, 'storageLimit': 0, 'storagePercentage': 0.0, 'assets': {'1004536': {'netPercentage': 0.0, 'netLimit': 0, 'netRemaining': 0, 'netUsed': 0}, '1004787': {'netPercentage': 0.0, 'netLimit': 0, 'netRemaining': 0, 'netUsed': 0}}, 'netPercentage': 0.0, 'storageUsed': 0, 'storageRemaining': 0, 'freeNetLimit': 1500, 'energyUsed': 0, 'freeNetRemaining': 1500, 'netLimit': 7382, 'netRemaining': 7382, 'energyLimit': 0, 'freeNetUsed': 0, 'totalNetWeight': 40961244084, 'freeNetPercentage': 0.0, 'energyPercentage': 0.0, 'totalNetLimit': 43200000000}, 'date_created': 1659175278000, 'accountType': 0, 'exchanges': [], 'frozen': {'total': 7000000000, 'balances': [{'expires': 1659780885000, 'amount': 7000000000}]}, 'accountResource': {'frozen_balance_for_energy': {}}, 'transactions': 76, 'witness': 0, 'delegateFrozenForBandWidth': 0, 'name': '', 'frozenForEnergy': 0, 'acquiredDelegateFrozenForEnergy': 0, 'activePermissions': [{'operations': '7fff1fc0033e0300000000000000000000000000000000000000000000000000', 'keys': [{'address': 'TLfJspfNmY77ZnWSXgFCAanKo5ApxXKBse', 'weight': 1}], 'threshold': 1, 'id': 2, 'type': 'Active', 'permission_name': 'active'}]}]
        api.request.side_effect = responses
        for address in self.addresses:
            staking_info = StakingInterface.get_info('TRX', address)
            assert staking_info.address == 'TLfJspfNmY77ZnWSXgFCAanKo5ApxXKBse'
            assert staking_info.staked_balance == 7000
            assert staking_info.total_balance == Decimal('7103.575350')
            assert staking_info.rewards_balance == Decimal('95.962337')
            assert staking_info.free_balance == Decimal('103.575350')
