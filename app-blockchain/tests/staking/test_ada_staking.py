from _decimal import Decimal
from datetime import datetime, timedelta
from unittest import TestCase
from unittest.mock import Mock

from exchange.blockchain.api.ada.cardano_graphql import CardanoAPI
from exchange.blockchain.staking.staking_interface import StakingInterface


class TestAdaStaking(TestCase):

    def test_get_staking_info(self):
        api = CardanoAPI.get_api()
        api.request = Mock()
        api.request.return_value = {'data': {'activeStake': [{'epochNo': 382, 'address': 'stake1uymdt2z2898l2263r82st67mh5g2cejjz3hps3cxm3d6w6sr740h9',  'amount': '1009223169'}], 'withdrawals': [            {'address': 'stake1uymdt2z2898l2263r82st67mh5g2cejjz3hps3cxm3d6w6sr740h9', 'amount': '8360326'}],                                             'rewards_aggregate': {'aggregate': {'sum': {'amount': '12568130'}}}},                                    'extensions': {'tracing': {'version': 1, 'startTime': '2022-12-21T06:21:52.014Z',                                                               'endTime': '2022-12-21T06:21:52.214Z',                                                               'duration': 200204528, 'execution': {'resolvers': [                                            {'path': ['activeStake'], 'parentType': 'Query', 'fieldName': 'activeStake',                                             'returnType': '[ActiveStake]!', 'startOffset': 260213,                                             'duration': 199893487},                                            {'path': ['withdrawals'], 'parentType': 'Query', 'fieldName': 'withdrawals',                                             'returnType': '[Withdrawal]!', 'startOffset': 2877859,                                             'duration': 28000472},                                            {'path': ['rewards_aggregate'], 'parentType': 'Query',                                             'fieldName': 'rewards_aggregate', 'returnType': 'Reward_aggregate!',                                             'startOffset': 9434651, 'duration': 166098909},                                            {'path': ['withdrawals', 0, 'address'], 'parentType': 'Withdrawal',                                             'fieldName': 'address', 'returnType': 'StakeAddress!',                                             'startOffset': 30887325, 'duration': 4589},                                            {'path': ['withdrawals', 0, 'amount'], 'parentType': 'Withdrawal',                                             'fieldName': 'amount', 'returnType': 'String!', 'startOffset': 30895732,                                             'duration': 1827}, {'path': ['rewards_aggregate', 'aggregate'],                                                                 'parentType': 'Reward_aggregate',                                                                 'fieldName': 'aggregate',                                                                 'returnType': 'Reward_aggregate_fields',                                                                 'startOffset': 175543738, 'duration': 7543},                                            {'path': ['rewards_aggregate', 'aggregate', 'sum'],                                             'parentType': 'Reward_aggregate_fields', 'fieldName': 'sum',                                             'returnType': 'Reward_sum_fields!', 'startOffset': 175554791,                                             'duration': 3774},                                            {'path': ['rewards_aggregate', 'aggregate', 'sum', 'amount'],                                             'parentType': 'Reward_sum_fields', 'fieldName': 'amount',                                             'returnType': 'String', 'startOffset': 175568450, 'duration': 2054},                                            {'path': ['activeStake', 0, 'epochNo'], 'parentType': 'ActiveStake',                                             'fieldName': 'epochNo', 'returnType': 'Int!', 'startOffset': 200163853,                                             'duration': 6350},                                            {'path': ['activeStake', 0, 'address'], 'parentType': 'ActiveStake',                                             'fieldName': 'address', 'returnType': 'StakeAddress!',                                             'startOffset': 200172891, 'duration': 1362},                                            {'path': ['activeStake', 0, 'amount'], 'parentType': 'ActiveStake',                                             'fieldName': 'amount', 'returnType': 'String!', 'startOffset': 200178051,                                             'duration': 1282}]}}}}

        address = 'stake1uymdt2z2898l2263r82st67mh5g2cejjz3hps3cxm3d6w6sr740h9'
        staking_info = StakingInterface.get_info('ADA', address, start_reward_period=datetime.today() - timedelta(days=10), end_reward_period=datetime.today())
        assert staking_info.address == 'stake1uymdt2z2898l2263r82st67mh5g2cejjz3hps3cxm3d6w6sr740h9'
        assert staking_info.staked_balance == Decimal('1009.223169')
        assert staking_info.total_balance == Decimal('1009.223169')
        assert staking_info.rewards_balance == Decimal('12.568130')
        assert staking_info.claimed_rewards == Decimal('8.360326')
